trigger:
- main

pool:
  name: SelfHostedWindows

variables:
  imageName: thonmaker
  acrName: thonmakeracr
  acrLoginServer: thonmakeracr.azurecr.io
  webAppName: thonmaker-app

steps:
# ---------------------------
# SAST â€“ Semgrep (FAIL on High/Critical-equivalent)
# Treat Semgrep ERROR as the gate. If any ERROR findings -> fail pipeline.
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"

    # Optional: force UTF-8 output (helps on Windows)
    chcp 65001 | Out-Null
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    $env:PYTHONUTF8 = "1"
    $env:PYTHONIOENCODING = "utf-8"

    python -m pip install --upgrade pip
    python -m pip install --upgrade semgrep

    # Fail pipeline on findings at ERROR level
    # --error ensures non-zero exit code when findings occur
    semgrep scan --config=auto --severity=ERROR --error --metrics=off
  displayName: "SAST - Semgrep (Fail on ERROR)"

# ---------------------------
# Build Docker image
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    docker build -t $(imageName):$(Build.BuildId) .
  displayName: "Build Docker Image"

# ---------------------------
# Ensure Trivy exists (install if missing)
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"

    if (-not (Get-Command trivy -ErrorAction SilentlyContinue)) {
      if (Get-Command winget -ErrorAction SilentlyContinue) {
        winget install --id AquaSecurity.Trivy -e --accept-package-agreements --accept-source-agreements
      } else {
        Write-Host "ERROR: winget not found on this agent"
        exit 1
      }
    }

    trivy -v
  displayName: "Install / Verify Trivy"

# ---------------------------
# Trivy Image Scan (FAIL on HIGH/CRITICAL)
# --exit-code 1 will fail if vulnerabilities are found at the selected severities
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    $env:TRIVY_CACHE_DIR = "$(Pipeline.Workspace)\trivy-cache"

    trivy image --severity HIGH,CRITICAL --exit-code 1 --no-progress $(imageName):$(Build.BuildId)
  displayName: "Trivy Image Scan (Fail on HIGH/CRITICAL)"

# ---------------------------
# Login to ACR using Azure CLI (uses AzureRM service connection)
# ---------------------------
- task: AzureCLI@2
  displayName: "Login to ACR"
  inputs:
    azureSubscription: sc-thonmaker-azure
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az --version
      az acr login --name $(acrName)

# ---------------------------
# Tag + Push image to ACR
# ---------------------------
- powershell: |
    $ErrorActionPreference = "Stop"
    docker tag $(imageName):$(Build.BuildId) $(acrLoginServer)/$(imageName):$(Build.BuildId)
    docker push $(acrLoginServer)/$(imageName):$(Build.BuildId)
  displayName: "Push Image to ACR"

# ---------------------------
# Deploy to Azure Web App (Container)
# ---------------------------
- task: AzureWebAppContainer@1
  displayName: "Deploy to Azure App Service"
  inputs:
    azureSubscription: sc-thonmaker-azure
    appName: $(webAppName)
    imageName: $(acrLoginServer)/$(imageName):$(Build.BuildId)
